# 定义上游Airflow服务器
upstream airflow_backend {
    server web:8080;
}

# 定义Lua包路径
lua_package_path "/usr/local/openresty/nginx/lua/?.lua;;";

server {
    listen 80;
    server_name _;
    
    # 日志配置
    access_log /usr/local/openresty/nginx/logs/access.log;
    error_log /usr/local/openresty/nginx/logs/error.log;

    # GitHub Webhook 请求处理
    location = /update {
        # 允许的HTTP方法
        if ($request_method !~ ^(POST)$) {
            return 405;
        }
        
        # 设置内容类型
        default_type text/plain;
        
        # 使用Lua脚本处理webhook请求
        content_by_lua_file /usr/local/openresty/nginx/lua/github_webhook.lua;
    }
    
    # 微信回调处理 - 使用Lua脚本处理并转发到Airflow API
    location = /wcf_callback {
        # 允许的HTTP方法
        if ($request_method !~ ^(POST)$) {
            return 405;
        }
        
        # 设置内容类型
        default_type application/json;
        
        # 使用Lua脚本处理微信回调并触发Airflow DAG
        content_by_lua_file /usr/local/openresty/nginx/lua/wcf_callback.lua;
    }
    
    # 健康检查端点
    location = /health {
        default_type text/plain;
        return 200 "OK";
    }
    
    # 所有其他请求返回404错误（使用Lua脚本处理）
    location / {
        default_type application/json;
        content_by_lua_file /usr/local/openresty/nginx/lua/not_found.lua;
    }
} 
# server块定义虚拟主机配置
server {
    # 指定Nginx监听的端口，这里是标准HTTP端口80
    listen 80;
    # server_name设置为下划线，表示接受所有域名的请求
    # 相当于一个默认的虚拟主机配置
    server_name _;
    
    # GitHub Webhook 请求处理路径
    # 当收到对 /update 路径的精确匹配请求时执行以下配置
    location = /update {
        # 检查HTTP方法，只允许POST请求
        # 如果不是POST请求，返回405状态码（方法不允许）
        if ($request_method !~ ^(POST)$) {
            return 405;
        }
        
        # 设置响应的内容类型为纯文本
        default_type text/plain;
        
        # 使用Lua脚本处理GitHub webhook请求
        # 这个脚本可能会验证webhook签名并触发代码更新或部署流程
        content_by_lua_file /usr/local/openresty/nginx/lua/github_webhook.lua;
    }
    
    # 微信回调处理路径
    # 当收到对 /wcf_callback 路径的精确匹配请求时执行以下配置
    location = /wcf_callback {
        # 检查HTTP方法，只允许POST请求
        # 如果不是POST请求，返回405状态码（方法不允许）
        if ($request_method !~ ^(POST)$) {
            return 405;
        }
        
        # 设置响应的内容类型为JSON
        default_type application/json;
        
        # 使用Lua脚本处理微信回调请求
        # 这个脚本可能会解析微信发送的数据，然后触发Airflow DAG运行
        content_by_lua_file /usr/local/openresty/nginx/lua/wcf_callback.lua;
    }
    
    # Airflow反向代理路径
    # 将/airflow开头的请求代理到Airflow Web服务
    location /airflow {
        # 删除/airflow前缀，保持URL路径的一致性
        rewrite ^/airflow(.*)$ $1 break;
        
        # 设置代理头信息
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 代理到Airflow Web服务
        proxy_pass $airflow_base_url;
        
        # 代理超时设置
        proxy_connect_timeout 90;
        proxy_send_timeout 90;
        proxy_read_timeout 90;
        
        # 处理WebSocket连接
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # 健康检查端点
    # 用于监控系统检查Nginx服务是否正常运行
    location = /health {
        # 设置响应的内容类型为纯文本
        default_type text/plain;
        # 直接返回200状态码和"OK"文本，表示服务正常
        return 200 "OK";
    }
    
    # 处理所有其他请求路径
    # 作为默认处理，匹配任何未被上面location块匹配的请求
    location / {
        # 设置响应的内容类型为JSON
        default_type application/json;
        # 使用Lua脚本返回404错误
        # 这可能是为了提供格式化的JSON错误响应
        content_by_lua_file /usr/local/openresty/nginx/lua/not_found.lua;
    }
} 